/**
 * @projectDescription A JS implementation of a Google Code Wiki to HTML converter - wikignpi version
 * @link http://code.google.com/p/wikiwym
 * @author Stephan Beal
 * @author Fabien Mï¿½nager
 * @link http://code.google.com/p/wikignpi
 * @author Bruno Santos
 * @license MIT License <http://www.opensource.org/licenses/mit-license.php>
 *
 * Usage:
 *   var p = new GoogleCodeWikiParser();
 *   print( p.parse( "... GoogleCode Wiki-syntax input ...") );
 *
 * Missing features vis-a-vis Google Code Wiki:
 *  - Nested lists.
 *  - Only [Bracketed] WikiWords, not unmarked WikiWords, are marked up.
 *    The exception is !WikiWord, which is parsed to WikiWord.
 *  - <wiki:toc/> is very rudimentary (a flat list).
 *
 * Known problems/limitations:
 *  - Inline markup is only matched across a single line. Consecutive
 *    lines are not crossed.
 *  - Certain CSS styles are hard-coded because GoCo does it that way.
 *  - The spacing/line breaks are not quite right when it comes
 *    handling to blank lines.
 *  - Block-level elements are processed twice. We should cache/re-use
 *    the result for the second pass. (The first pass just figures out
 *    which lines to exclude from the inline-markup parsing phase.)
 *  - A {{{...}}} inside backticks will not render properly. Since those are an alias
 *    for backticks, i'm not going to worry about this.
 */
function GoogleCodeWikiParser(showsummary,showlabels){var ps=this;this.inTable=0;this.listLevel=0;this.inCode=0;this.inBQ=0;this.hList=[];this.liSpaces=[];this.liTags=[];this.showsummary=showsummary==undefined?true:showsummary;this.showlabels=showlabels==undefined?true:showlabels;this.gadgetCounter=0;this.rx={wikiWord:/\b([A-Z]\w+)\b/,headers:[[/^\s*======\s*([^<>=]+?)\s*======/,ps.headN(6)],[/^\s*=====\s*([^<>=]+?)\s*=====/,ps.headN(5)],[/^\s*====\s*([^<>=]+?)\s*====/,ps.headN(4)],[/^\s*===\s*([^<>=]+?)\s*===/,ps.headN(3)],[/^\s*==\s*([^<>=]+?)\s*==/,ps.headN(2)],[/^\s*=\s*([^<>=]+?)\s*=/,ps.headN(1)],[/^\s*#summary\s+(.*)$/i,ps.showsummary?'<p class="summary">$1</p>':''],[/^\s*#labels\s+(.*)$/i,ps.showlabels?'<span class="label">$1</span>':''],[/^\s*#sidebar.*$/i,function(){return ps.getWarning("The `#sidebar` directive is not supported by this parser!")}]],block:{PLACEHOLDER:{rx:/^ONLY_FOR_DOCUMENTATION_PURPOSES$/,doLine:function(line,result){return-1;}},table:{rx:/^\s*\|\|/,doLine:function(line,result){var cells=line?(''+line).split('||'):null;if(cells)cells.shift();if(!cells||!cells.length){ps.inTable=0;result.push('</table><br>');return-1;}else{cells=cells.slice(0,cells.length-1);}var out=[];++ps.inTable;if(ps.inTable==1){out.push('<table>');}out.push('<tr>');var tag='td';var c;for(var i in cells){if(!cells.hasOwnProperty(i))continue;c=cells[i];if(c instanceof Function)continue;out.push('<',tag,' style="border: 1px solid #aaa; padding: 5px;">',ps.parseInlined(c),'</',tag,'>');}out.push('</tr>');result.push(out.join(''));return 1;}},code:{rx:/^\s*\{\{\{(.*)/,doLine:function(line,result){var m;if((undefined===line)||(m=/(.*)}}}(.*)/.exec(line))){ps.inCode=0;if(m&&m[1])result.push(m[1]);result.push('</pre><br>');if(m&&m[2])result.push(ps.parseInlined(m[2]));return 0;}++ps.inCode;if(1==ps.inCode){result.push('<pre class="prettyprint">');m=this.rx.exec(line);if(m&&m[1])result.push(m[1].replace(/&/g,'&amp;').replace(/</g,'&lt;'));}else{result.push((line&&line.length)?line.replace(/&/g,'&amp;').replace(/</g,'&lt;'):'');}return 1;}},listOLUL:{rx:/^(\s+)([#*])\S*\s+(.*)/,doLine:function(line,result,tag){var m;if(!(m=this.rx.exec(line))){while(ps.liTags.length){result.push('</'+(ps.liTags[ps.liTags.length-1])+'>');ps.liTags=ps.liTags.slice(0,ps.liTags.length-1);}ps.listLevel=0;ps.liSpaces=[];return-1;}tag=('#'==m[2])?'ol':'ul';var sp=m[1];var prevSpace=ps.liSpaces.length?ps.liSpaces[ps.liSpaces.length-1]:'';var prevTag=ps.liTags.length?ps.liTags[ps.liTags.length-1]:tag;if((sp.length>prevSpace.length)){++ps.listLevel;ps.liTags.push(tag);result.push('<'+tag+'>');ps.liSpaces.push(sp);}else if((sp.length<prevSpace.length)){while(ps.liSpaces.length&&(sp.length<prevSpace.length)){--ps.listLevel;result.push('</'+ps.liTags[ps.liTags.length-1]+'>');ps.liTags=ps.liTags.slice(0,ps.liTags.length-1);ps.liSpaces=ps.liSpaces.slice(0,ps.liSpaces.length-1);prevSpace=ps.liSpaces[ps.liSpaces.length-1];}}else if(0==ps.listLevel){++ps.listLevel;ps.liTags.push(tag);result.push('<'+tag+'>');ps.liSpaces.push(sp);}else if(prevTag!=tag){result.push('</'+ps.liTags[ps.liTags.length-1]+'>');ps.liTags[ps.liTags.length-1]=tag;result.push('<'+tag+'>');}result.push('<li'+'>'+ps.parseInlined(m[3])+'</li>');return 1;}},blockquote:{rx:/^\s+(\S.*)/,doLine:function(line,result){var m;if(!(m=this.rx.exec(line))){ps.inBQ=0;result.push('</blockquote>');return-1;}++ps.inBQ;if(ps.inBQ==1){result.push('<blockquote>');if(m&&m[1])result.push(ps.parseInlined(m[1]));}else{result.push(ps.parseInlined(line));}return 1;}}}};};GoogleCodeWikiParser.prototype.headerReplace=function headerReplace(lvl,$1){var norm=$1.replace(/\s+/g,'_').replace(/["`]/g,'');this.hList.push({level:lvl,name:$1,href:'#'+norm});return'<h'+lvl+'><a name="'+norm+'"></a>'+$1+'</h'+lvl+'>';};GoogleCodeWikiParser.prototype.headN=function headN(N){var n=N;var self=this;return function($0,$1){return self.headerReplace(n,$1);};};GoogleCodeWikiParser.prototype.tagsFor={'*':'strong','_':'em','^':'sup','~':'strike',',':'sub'};GoogleCodeWikiParser.prototype.options={disableWarnings:false,outputSeparator:'',wikiBaseURL:'',openURLSInNewWindow:false,wikilist:new Array(),hideComments:true,showGadgets:true,showVideos:true,injectAfterLabels:''};GoogleCodeWikiParser.prototype.getWarning=function(text){return this.options.disableWarnings?'':'<span style="color:red;background-color:yellow;">WIKI PARSE WARNING: '+text+'</span>';};GoogleCodeWikiParser.prototype.aliases=[[/(\{{3}([^\}]+)\}{3})/,'`$2`']];GoogleCodeWikiParser.prototype.parseAliases=function(snippet){var x,pair,length=this.aliases.length;for(x=0;x<length;++x){pair=this.aliases[x];while(pair[0].test(snippet)){snippet=snippet.replace(pair[0],pair[1]);}}return snippet;};GoogleCodeWikiParser.prototype.parseLineVerbatim=function(text){if(!text)return text;var ch,i,x,buf='',end=text.length,out=[];function pushbuf(){if(buf){out.push(buf);buf='';}};for(i=0;i<end;++i){ch=text.charAt(i);if((undefined!==ch)&&('`'!==ch)){out.push(ch);continue;}pushbuf();out.push('<tt>');for(x=i+1;x<end;++x){ch=text.charAt(x);if((undefined===ch)||('`'===ch))break;buf+=ch;}buf=buf.replace(/&/,'&amp;').replace(/</g,'&lt;').replace(/[!_*,^~\[]/g,function($0){return'&#0'+$0.charCodeAt(0)+';';});pushbuf();if('`'!==ch){out.push(this.getWarning("unterminated backtick!"));}out.push('</tt>');i=x;}pushbuf();return out.join('');};GoogleCodeWikiParser.prototype.parseInlined=function(text){text=''+text;if(!text||!text.length){return'';}var end,i,x,ch,buf="",space,ma,marker,tag,skipIfPrevIs=/[a-zA-Z]/,out=[];function append(val){out.push(val);}function pushbuf(){if(buf.length){append(buf);buf="";}}var headersCount=this.rx.headers.length;for(i=0;i<headersCount;++i){x=this.rx.headers[i];if(!x[0].test(text))continue;var old=text;text=text.replace(x[0],x[1]);if(/^#/.test(old)){buf+=text;pushbuf();return out.join('');}old=null;break;}text=this.parseLineVerbatim(this.parseAliases(text));if(ma=/^\s*(-{4,})([^-]?.*)/.exec(text)){text='<hr/>'+(ma[2]||'');if(!ma[2]){buf+=text;pushbuf();return out.join('');}}end=text.length;var prevChar;for(ch=0,i=0;i<end;++i){prevChar=ch;var ch=text.charAt(i);if(/\s/.test(ch)){buf+=ch;continue;}else if('<'===ch){if(!/[a-zA-Z\/]/.test(text.charAt(i+1))){buf+='&lt;';pushbuf();continue;}buf+=ch;for(x=i+1;x<end;++x){ch=text.charAt(x);buf+=ch;if('>'===ch)break;}if('>'!==ch){buf+=this.getWarning("unterminated less-than!");}pushbuf();i=x;continue;}else if('['===ch){if(prevChar&&!/\W/.test(prevChar)){buf+=ch;continue;}else if(!/[a-zA-Z#]/.test(text.charAt(i+1))){buf+='[';continue;}pushbuf();for(x=i+1;x<end;++x){ch=text.charAt(x);if(']'===ch)break;buf+=ch;}if(']'!==ch){buf+=this.getWarning("unterminated '['!");}else{var sp=buf.split(/\s+/,2);tag=(sp&&(sp.length>1))?buf.substr(sp[0].length):(sp?sp[0]:'WIKI_PARSING_ERROR');buf=this.createLink(sp[0],tag);}pushbuf();i=x;continue;}else if('!'===ch){marker=i;pushbuf();for(x=i+1;/\w/.test((ch=text.charAt(x)));){buf+=ch;++x;}if(ma=this.rx.wikiWord.exec(buf)){buf=ma[1]+ch;pushbuf();i=x;}else{i=marker;buf='!';pushbuf();}continue;}else if(ma=/([\*_^])/.exec(ch)){if(prevChar&&skipIfPrevIs.test(prevChar)){buf+=ch;continue;}pushbuf();tag=this.tagsFor[ma[1]];append('<'+tag+'>');for(x=i+1;x<end;++x){ch=text.charAt(x);if(ma[1]===ch)break;buf+=ch;}if(ma[1]!==ch){buf+=this.getWarning("unterminated '"+ma[1]+"'!");}else if(buf){buf=this.parseInlined(buf);}pushbuf();append('</'+tag+'>');i=x;continue;}else if(ma=/([~,])/.exec(ch)){if(prevChar&&skipIfPrevIs.test(prevChar)){buf+=ch;continue;}if(text.charAt(i+1)!=ma[1]){buf+=ma[1];continue;}pushbuf();x=i+2;ch=text.charAt(x);tag=this.tagsFor[ma[1]];append('<'+tag+'>');for(;(x<end);){if(ch==ma[1]){if(text.charAt(x+1)==ma[1]){++x;break;}}buf+=ch;ch=text.charAt(++x);}i=x;if(ma[1]!=ch){buf=ma[1]+ma[1]+buf;buf+=this.getWarning("mis-terminated '"+ma[1]+ma[1]+"'!");}else{buf=this.parseInlined(buf);}pushbuf();append('</'+tag+'>');continue;}else{buf+=ch;}}pushbuf();return out.join('');};GoogleCodeWikiParser.prototype.renderTOC=function(maxDepth){maxDepth=maxDepth||3;var hl=this.hList;var out=[];var h;var i;var ps=this;function render(h){var sp='';for(var x=0;x<h.level;++x)sp+='  ';var a="* <a href='"+h.href+"'"+">"+ps.parseInlined(h.name)+"</a>";out.push(sp+a);}for(i in hl){var h=hl[i];if(h.level>maxDepth)continue;render(h);}var rc,ln;var result=[];var res;for(i=0;i<=out.length;++i){res=[];ln=out[i];rc=this.rx.block.listOLUL.doLine(ln,res);if(!res.length)break;ln=res.join('');result.push(ln);if(rc<=0)break;}return result.join('');};GoogleCodeWikiParser.prototype.createLink=function(where,label){where=encodeURI(where);var img,ma;var rximg=/(gif|jpe?g|bmp|png|tiff?)$/i;var inTarget=this.options.openURLSInNewWindow&&!(where[0]=='#')?' target="_blank"':'';if(rximg.test(label)){img=label;}if(img){if(where===label){return'<img src="'+img+'" />';}else{return'<a href="'+where+'">'+'<img src="'+img+'" /></a>';}}label=label||where;if(where.indexOf('/')<0&&this.options.wikiBaseURL.length>0&&!(where[0]=='#')){var where2=where.split('#');if(where2.length>0&&findIdx(where2[0],this.options.wikilist)>=0){var pageName=where2[0];where2.shift();where=where2.length>0?('#'+where2.join('#')):'#'+pageName;inTarget='';}else{where=this.options.wikiBaseURL+where;}}return'<a href="'+where+'"'+inTarget+'>'+label.replace(/&/g,'&amp;').replace(/</g,'&lt;')+'</a>';};function findIdx(item,arr){var idx=-1;var last=arr.length;for(var i=0;i<last;i++){idx=(item==arr[i])?i:-1;if(-1!=idx)break;}return idx;}GoogleCodeWikiParser.prototype.processWikiGadgetLink=function(rgres){var rxtoc=/(\S+)=["']((?:.(?!["']?\s+(?:\S+)=|[>"']))+.|\d+)["']/;var rxarr=/(^url$|^height$|^width$|^border$)/;var ma,i;var arr={};while(ma=rxtoc.exec(rgres)){arr[ma[1]]=ma[2];rgres=rgres.replace(ma[0],'');}ma='<h2 class="gadget-title" id="gadget'+this.gadgetCounter+'_title"></h2>';ma+='<iframe name="gadget'+this.gadgetCounter+'" id="gadget'+this.gadgetCounter+'"';if(arr['height'])ma+=' height="'+arr['height']+'"';if(arr['width'])ma+=' width="'+arr['width']+'"';if(arr['border'])ma+=' frameborder="'+arr['border'].replace(/["']{1}/gi,"")+'"';ma+=' src="http://code-opensocial.googleusercontent.com/gadgets/ifr?';if(arr['url'])ma+='url='+encodeURIComponent(arr['url']);for(key in arr){if(rxarr.exec(key)!=null)continue;ma+='&'+key+'='+encodeURIComponent(arr[key]);}ma+='&parent=%2F%2Fcode.google.com%2Fhosting&container=code"></iframe>';this.gadgetCounter++;return ma;};GoogleCodeWikiParser.prototype.processWikiVideoLink=function(rgres,showVid){var rxtoc=/(\S+)=["']((?:.(?!["']?\s+(?:\S+)=|[>"']))+.|\d+)["']/;var rxarr=/(^url$|^height$|^width$|^border$)/;var ma,i;var arr={width:"425",height:"344"};while(ma=rxtoc.exec(rgres)){arr[ma[1]]=ma[2];rgres=rgres.replace(ma[0],'');}if(showVid){if(arr['url'])arr['up_video']=arr['url'];arr['url']='http://google-code-project-hosting-gadgets.googlecode.com/svn/build/prod/video/gcVideo.xml';ma='<iframe name="gadget'+this.gadgetCounter+'" id="gadget'+this.gadgetCounter+'"';if(arr['height'])ma+=' height="'+arr['height']+'"';if(arr['width'])ma+=' width="'+arr['width']+'"';if(arr['border'])ma+=' frameborder="'+arr['border'].replace(/["']{1}/gi,"")+'"';ma+=' src="http://www.gmodules.com/gadgets/ifr?';if(arr['url'])ma+='url='+encodeURIComponent(arr['url']);for(key in arr){if(rxarr.exec(key)!=null)continue;ma+='&'+key+'='+encodeURIComponent(arr[key]);}ma+='&parent=%2F%2Fcode.google.com%2Fhosting&container=code"></iframe>';this.gadgetCounter++;}else{ma=' <a href="';if(arr['url'])ma+=arr['url'];ma+='"';if(this.options.openURLSInNewWindow)ma+=' target="_blank"';ma+='>';if(arr['url'])ma+=''+arr['url'];ma+='</a>';}return ma;};GoogleCodeWikiParser.prototype.InjectAfterLabels=function(out){if(this.options.injectAfterLabels.length==0)return;var labelOrSummaryPos=-1;if(this.showlabels){for(j in out){if(out[j].indexOf('<span class="label">')>=0){labelOrSummaryPos=parseInt(j);break;}}}else if(this.showsummary){for(j in out){if(out[j].indexOf('<p class="summary">')>=0){labelOrSummaryPos=parseInt(j);break;}}}if(labelOrSummaryPos<0){if(out.length==0){out[0]=this.options.injectAfterLabels;}else{out[0]=this.options.injectAfterLabels+'<br>'+out[0];}}else{out.splice(labelOrSummaryPos+1,0,'<br>'+this.options.injectAfterLabels);}};GoogleCodeWikiParser.prototype.parse=function(text){this.hList=[];this.lines=text?text.split(/\r?\n/):[];this.lineNo=0;this.blockLines=[];var out=[];var isblock=[];var i=0,k,x,bl,res,end=this.lines.length,ln;for(i=0;i<end;++i){ln=this.lines[i]=this.parseAliases(this.lines[i]);if(!ln||!ln.length)continue;var check;for(k in this.rx.block){if(!this.rx.block.hasOwnProperty(k))continue;check=this.rx.block[k];if(!check.rx.test(ln))continue;x=i;var rc=undefined;for(1;1;1){res=[];rc=check.doLine(ln,res);if(!res.length)break;isblock[i]=res.join('');if(rc<=0)break;ln=this.lines[++i];}res=null;if(rc<0)--i;if(undefined!==rc)break;}}for(i=0;i<end;++i){ln=this.lines[i];if(!isblock[i]){ln=this.parseInlined(ln);this.lines[i]=ln;}}var didMulti=false;var emptyCount=0;var prevSkipsBR=false;var skippedFirst=this.showsummary;for(i=0;i<this.lines.length;++i){ln=this.lines[i];if(i&&!ln.length){++emptyCount;continue;}if(emptyCount){if(!prevSkipsBR&&skippedFirst){out.push('<br><br>');}else if(!prevSkipsBR){skippedFirst=true;}emptyCount=0;}didMulti=false;prevSkipsBR=false;if(1&&isblock[i])for(k in this.rx.block){bl=this.rx.block[k];if(bl.rx.test(ln)){didMulti=true;prevSkipsBR=true;res=[];for(;(rc=bl.doLine(ln,res))>0;){ln=this.lines[++i];}for(k in res){if(!res.hasOwnProperty(k))continue;out.push(res[k]);}res=null;if(rc<0)--i;break;}}else if(undefined!==isblock[i]){ln=this.parseInlined(isblock[i]);didMulti=true;prevSkipsBR=true;out.push(ln);continue;}if(didMulti){continue;}else if(i>=end)break;out.push(ln);if(/(<\/h\d)|(<\/table)|(<\/[uo]l)|(<\/pre)|(<\/block)/.test(ln)){prevSkipsBR=true;}emptyCount=0;}this.lines=null;if(1){var rxtoc=/<wiki:toc\s*(max_depth=["']?(\d+)["']?)?[^>]*>([^<]*<\/wiki[^>]+>)?/;var ma;for(i=0;i<out.length;++i){ln=out[i];if(!(ma=rxtoc.exec(ln)))continue;var maxdepth=ma[2]||3;var toc=this.renderTOC(maxdepth);out[i]=ln.replace(ma[0],toc);break;}}if(this.options.hideComments){var rxtoc=/<wiki:comment\s*[^>]*>.*<\/wiki:comment\s*[^>]*>/;var rxtoc1=/<wiki:comment\s*[^>]*>?/;var rxtoc2=/<\/wiki:comment\s*[^>]*>?/;var ma;for(i=0;i<out.length;++i){ln=out[i];if(!(ma=rxtoc1.exec(ln)))continue;var j=-1;for(i2=i;i2<out.length&&j<0;++i2){ln=out[i2];if(!(ma=rxtoc2.exec(ln)))continue;j=i2;}if(j<0)continue;ln=out.slice(i,j+1).join(this.options.outputSeparator);if(!(ma=rxtoc.exec(ln)))continue;out[i]=ln.replace(ma[0],'');if(i<j)out.splice(i+1,j-i);if(out[i].length==0){out.splice(i,1);i--;}if(out[i]==out[i+1]&&out[i]=='<br><br>'){out.splice(i,1);i--;}}}if(this.options.showGadgets){var rxtoc=/<wiki:gadget[^>]*>(<\/wiki:gadget\s*[^>]*>)*/;var ma;for(i=0;i<out.length;++i){ln=out[i];if(!(ma=rxtoc.exec(ln)))continue;var wgblock=this.processWikiGadgetLink(ma[0]);out[i]=ln.replace(ma[0],wgblock);}}if(1){var rxtoc=/<wiki:video[^>]*>(<\/wiki:video\s*[^>]*>)*/;var ma;for(i=0;i<out.length;++i){ln=out[i];if(!(ma=rxtoc.exec(ln)))continue;var wgblock=this.processWikiVideoLink(ma[0],this.options.showVideos);out[i]=ln.replace(ma[0],wgblock);}}if(this.options.injectAfterLabels.length>0)this.InjectAfterLabels(out);return out.join(this.options.outputSeparator);};GoogleCodeWikiParser.parse=function(text){return(new GoogleCodeWikiParser()).parse(text);};